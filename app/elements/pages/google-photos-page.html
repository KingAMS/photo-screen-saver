<!--
@@license
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../../bower_components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-label/iron-label.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-tooltip/paper-tooltip.html">

<script src="../../scripts/google_photos.js"></script>

<dom-module id="google-photos-page">
	<template>
		<style include="shared-styles"></style>
		<style>

		:host {
			display: block;
			position: relative;
		}

		.page-toolbar {
			margin: 0;
		}

		.page-content {
			height: 800px;
			overflow: hidden;
			overflow-y: scroll;
			margin: 0;
		}

		.waiter {
			margin: 40px auto;
		}

		.waiter paper-item {
			font: var(--paper-font-title);
			margin: 40px auto;
		}

		.list-item {
			position: relative;
			border-bottom-style: solid;
			border-color:	#CCCCCC;
			border-width: 1px;
			padding: 0;
			padding-left: 5px;
			cursor: pointer;
		}

		.list-item paper-item-body {
			padding-left: 10px;
		}

		.list-item paper-item {
			padding-right: 0;
		}

		.list-item iron-image {
			height: 72px;
			width: 72px;
		}

		.list-item[disabled] iron-image {
			opacity: .2;
		}

		.list-item[disabled] {
			pointer-events: none;
		}

		.list-item[disabled] .setting-label {
			color: var(--disabled-text-color);
		}

		</style>

		<paper-material elevation="1" class="page-container">
			<paper-material elevation="1">
				<paper-toolbar class="page-toolbar">
					<div class="flex">Google Photos Albums</div>
					<paper-icon-button id="deselect" icon="check-box-outline-blank" on-tap="_deselectTapped" disabled$="[[!useGoogle]]"></paper-icon-button>
					<paper-tooltip for="deselect" position="left" offset="0">Deselect all albums</paper-tooltip>
					<paper-icon-button id="refresh" icon="refresh" on-tap="_refreshTapped" disabled$="[[!useGoogle]]"></paper-icon-button>
					<paper-tooltip for="refresh" position="left" offset="0">Refresh album list</paper-tooltip>
					<paper-toggle-button id="googlePhotosToggle" checked="{{useGoogle}}"></paper-toggle-button>
					<paper-tooltip for="googlePhotosToggle" position="left" offset="0">Enable/disable use of albums</paper-tooltip>
					<iron-localstorage name="useGoogle" value="{{useGoogle}}"></iron-localstorage>
				</paper-toolbar>
			</paper-material>

			<div class="page-content">

				<div class="waiter" hidden$="[[!waitForLoad]]">
					<div class="horizontal center-justified layout">
						<paper-spinner alt="Loading Albums" active="[[waitForLoad]]"></paper-spinner>
					</div>
					<paper-item class="horizontal center-justified layout">Loading Albums</paper-item>
				</div>

				<div class="list-container" hidden$="[[waitForLoad]]">
					<template is="dom-repeat" id="t" items="{{albums}}">
						<div class="list-item" id="[[item.uid]]" disabled$="[[!useGoogle]]">
							<iron-label>
								<paper-item class="center horizontal layout" tabindex="-1">
									<paper-checkbox iron-label-target checked="{{item.checked}}" on-change="_albumSelectChange" disabled$="[[!useGoogle]]"></paper-checkbox>
									<paper-item-body class="flex" two-line>
										<div class="setting-label">{{item.name}}</div>
										<div class="setting-label" secondary><span>[[item.ct]]</span><span>&nbsp;photos</span></div>
										<paper-ripple center></paper-ripple>
									</paper-item-body>
									<iron-image src="[[item.thumb]]" sizing="cover" preload disabled$="[[!useGoogle]]"></iron-image>
								</paper-item>
							</iron-label>
						</div>
					</template>
				</div>
			</div>
			<content></content>
		</paper-material>
	</template>
</dom-module>

<script>
	GooglePhotosPage = Polymer({
		is: 'google-photos-page',

		// so we can lazily create the page
		factoryImpl: function(id, dialogEl, dialogTextEl) {
			this.setAttribute('id', id);
			this.dialogEl = dialogEl;
			this.dialogTextEl = dialogTextEl;
		},

		properties: {

			albums: {
				type: Array,
				notify: true,
				value: []
			},

			selections: {
				type: Array,
				value: []
			},

			waitForLoad: {
				type: Boolean,
				value: false
			},

			dialogEl: {
				type: Object,
				value: {}
			},

			dialogTextEl: {
				type: Object,
				value: {}
			}

		},

		ready: function() {
			this.loadAlbumList();
		},

		// Query Picasa for the list of the users albums
		loadAlbumList: function() {
			this.set('waitForLoad', true);
			gPhotos.loadAlbumList(function(error, albums) {
				if (!error) {
					this.splice('albums', 0, this.albums.length);
					for (var i = 0; i < albums.length; i++) {
						this.push('albums', JSON.parse(JSON.stringify(albums[i])));
					}
					this._selectAlbums();
					gPhotos.updateImages();
				} else {
					this.dialogTextEl.innerHTML = error;
					this.dialogEl.open();
				}
				this.set('waitForLoad', false);
			}.bind(this));
		},

		// set the checked state of the albums
		_selectAlbums: function() {
			this.selections = JSON.parse(localStorage.albumSelections);
			for (var i = 0; i < this.albums.length; i++) {
				for (var j = 0; j < this.selections.length; j++) {
					if (this.albums[i].id === this.selections[j].id) {
						this.set('albums.' + i + '.checked', true);
						break;
					}
				}
			}
		},

		// refresh the album list
		_refreshTapped: function() {
			this.loadAlbumList();
		},

		// handle interactive album selections
		_albumSelectChange: function(event) {
			var item = event.model.item;
			var index = this.selections.map(function(e) {return e.id;}).indexOf(item.id);

			if (index !== -1) {
				this.selections.splice(index, 1);
			}

			if (item.checked) {
				this.selections.push({id: item.id, photos: item.photos});
			}

			localStorage.albumSelections = JSON.stringify(this.selections);
		},

		// deselect all albums
		_deselectTapped: function() {
			for (var i = 0; i < this.albums.length; i++) {
				if (this.albums[i].checked) {
					this.set('albums.' + i + '.checked', false);
				}
			}
			this.selections.splice(0, this.selections.length);
			localStorage.albumSelections = JSON.stringify(this.selections);
		}

	});
</script>
